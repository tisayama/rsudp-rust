# 機能仕様書: シミュレーション用 UDP MiniSEED ストリーマー

**機能ブランチ**: `009-udp-mseed-streamer`  
**作成日**: 2025-12-19  
**ステータス**: 計画準備完了  
**インプット**: ユーザー説明: "mseedファイルをUDPパケットで時間間隔まで考慮して流すテストの仕組みを作って。"

## Clarifications

### Session 2025-12-19
- Q: UDPパケットのフォーマット (FR-007) → A: デコード済みデータ (rsudp 形式)。ストリーマーが内容をデコードし、`rsudp` 互換の JSON 風文字列として送信します。
- Q: 複数チャンネルの送信順序 → A: 厳密な時系列順に再ソート。ファイル全体の全チャンネルを読み込み、開始時刻が早い順にパケットを並べ替えて送信します。
- Q: 大きな時間ギャップの扱い → A: 厳密に維持（そのまま待機）。ファイル内の時間の通りに待機します。1時間のギャップがあれば、リアルタイムモードでは1時間待機します。
- Q: メモリ管理戦略 (SC-002) → A: インデックス化＋オンデマンド読込。時刻とファイルオフセットのみをメモリに保持してソートし、データ実体は送信直前にディスクから読み込みます。
- Q: ネットワークおよびステーション情報の柔軟性 → A: ファイルの内容を厳密に使用。MiniSEED に記録されているネットワーク・ステーション情報をそのままパケットに含めて送信します。

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - リアルタイム地震シミュレーション (優先度: P1)

開発者として、過去の地震データを MiniSEED ファイルから `rsudp-rust` レシーバーに元のペースで流したい。複数の観測チャンネルが混在していても、それらが厳密な時系列順にインターリーブして送信されることで、実際のセンサーネットワークからの入力に近い挙動を再現できる。また、データ欠落（ギャップ）やネットワーク・ステーションのメタデータもファイル内の記録通りに再現される必要がある。

**この優先度の理由**: 物理センサーなしで現実的なシステムテストやデモンストレーションを行うための基本要件であるため。

**独立したテスト**: リファレンスとなる MiniSEED ファイルを用意し、ストリーマーをレシーバーのポートに向ける。レシーバーがデータの到着をログに記録し、WebUI がリアルタイムで波形を表示することを確認する。

**受け入れシナリオ**:

1. **前提**: 60秒分のデータを含む MiniSEED ファイルがある。**操作**: 1倍速でストリーミングする。**結果**: 処理完了までにおよそ60秒かかること。
2. **前提**: ストリーマーが動作している。**操作**: `rsudp-rust` がパケットを受信する。**結果**: ログに記録されるタイムスタンプおよびステーション名がファイル内のメタデータと一致し、常に時間が増加する順（単調増加）で受信されること。

---

### ユーザーストーリー 2 - 高速データ再生 (優先度: P2)

テスターとして、データを10倍速や100倍速で流したい。これにより、長期間のデータに対するインジェクションパイプラインや計測震度計算の安定性を短時間で検証できる。

**この優先度の理由**: 計算ロジックのストレステストや回帰テストに不可欠であるため。

**独立したテスト**: ストリーマーを速度倍率指定（例: `--speed 10`）で実行する。10分間のデータが1分で処理されることを確認する。

**受け入れシナリオ**:

1. **前提**: 1時間分の MiniSEED ファイルがある。**操作**: 60倍速でストリーミングする。**結果**: ファイル全体が60秒で送信されること。
2. **前提**: 高速ストリーミングを実行する。**操作**: システムリソースを監視する。**結果**: ソケットレベルでのパケットロスが発生せず、CPUとメモリの使用率が安定していること。

---

### ユーザーストーリー 3 - ループ再生シミュレーション (優先度: P3)

QAエンジニアとして、ファイルの終わりに達したら自動的に再生を繰り返したい。これにより、安定性テスト中にシステムを長時間稼働させ続けることができる。

**この優先度の理由**: 長時間の連続稼働テスト（Soak Test）に有用であるため。

**独立したテスト**: ループモードを有効にする。最後のレコードが送信された後、ストリーマーが即座に最初のレコードから再開することを確認する。

**受け入れシナリオ**:

1. **前提**: ループモードが有効である。**操作**: MiniSEED ファイルの終端に達する。**結果**: ストリーマーが終了せずに再生を継続すること。

### エッジケース

- **可変サンプリングレート**: MiniSEED ファイル内に異なるサンプリングレートのトレースが含まれている場合、どう処理するか？（仮定: ストリーマーはレコードをそのまま送信し、レシーバー側でレート変更を処理する）。
- **ネットワークの混雑**: UDP ソケットのバッファが一杯になった場合、どうなるか？（仮定: ストリーマーは警告をログに記録して続行する。UDP は本質的にロスを許容する）。
- **長時間の時間ギャップ**: リアルタイムモードにおいて、ファイル内の数時間の空白もそのまま待機する。

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムはローカルファイルシステムから MiniSEED ファイルを読み込むことができなければならない。
- **FR-002**: システムは送信開始前にファイルをスキャンし、各レコードの開始時刻、ファイル上の位置（オフセット）、およびメタデータ（ネットワーク、ステーション）をインデックス化しなければならない。
- **FR-003**: システムは全チャンネルのレコードを時刻順にソートし、オンデマンドでディスクから読み込んで送信しなければならない。
- **FR-004**: システムは設定可能な IP アドレスとポートに対して UDP でデータを送信できなければならない。
- **FR-005**: システムは「リアルタイムモード」を実装し、パケット送信の間隔がパケット内のサンプルが表す時間長と等しくなければならない。ファイル内の時間ギャップも忠実に再現しなければならない。
- **FR-006**: システムは再生速度の倍率（例: 0.5倍、2倍、10倍）を設定できなければならない。
- **FR-007**: システムはファイル先頭から再生を再開するオプションの「ループモード」をサポートしなければならない。
- **FR-008**: システムはデコード済みデータ (rsudp 形式) をサポートしなければならない。ストリーマーが内容をデコードし、ファイル内のメタデータを保持したまま、`rsudp` 互換の JSON 風文字列（例: `{'EHZ', 1582315130.292, ...}`）として送信する。

### 主要なエンティティ

- **MiniSEED Record**: ヘッダー（タイムスタンプ、ネットワーク、ステーション情報含む）と圧縮された地震データを含む 512 バイトのブロック。
- **レコードインデックス**: 時刻順にソートされた、各レコードの時刻、ファイルポインタ、メタデータのリスト。
- **再生クロック (Playback Clock)**: ファイルデータの時間と現実の時間を同期させるための論理クロック。速度倍率によって調整される。
- **rsudpパケット**: デコードされたサンプルデータを含む文字列。チャンネル名、開始秒、サンプル配列を含む。

## Success Criteria *(mandatory)*

### 測定可能な成果

- **SC-001**: 1倍速において、タイミングジッター（理想的なパケット配信時間からのズレ）が平均 5ms 未満であること。
- **SC-002**: 最大 2GB までのファイルを過度なメモリ消費なしでシミュレーションできること（インデックス方式による低メモリフットプリント）。
- **SC-003**: ネットワークバッファが許す限り、送信パケットが 100% 送出されること。
- **SC-004**: ユーザーが実行中にシミュレーション速度を切り替えられること（オプションだが高価値）。