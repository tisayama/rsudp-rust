# 機能仕様書: 総合アラートシステム (Comprehensive Alerting System)

**機能ブランチ**: `010-comprehensive-alerting`  
**作成日**: 2025-12-19  
**ステータス**: 計画準備完了  
**インプット**: ユーザー説明: "rsudpと同じ機能のアラートシステムを作ってほしいです。Telegram連携は不要です。"

## Clarifications

### Session 2025-12-19
- Q: アラート画像（スナップショット）の保存と閲覧方法 → A: ローカル保存 + WebUI表示。サーバーに画像を保存し、WebUIのアラート履歴リストから直接画像を表示できるようにします。
- Q: 音声アラートの出力場所 → A: ブラウザ側（クライアント）。WebUIを開いている各ブラウザで警告音が鳴るようにし、遠隔監視時でも即座に異常を察知可能にします。
- Q: メール通知の送信タイミング → A: 発生時と終了時の両方。発生（Trigger）時に即時通知を行い、終了（Reset）時に最大比率や画像URLを含む詳細通知を送信します。

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - リアルタイム視覚・音声通知 (優先度: P1)

ユーザーとして、地震が発生した瞬間にWebUIを通じて直感的に（視覚と聴覚で）異変に気づきたい。検知時に画面が赤く点滅し、ブラウザから警告音が鳴ることで、モニターを見ていなくても事態を把握できる。

**この優先度の理由**: アラートシステムの最も基本的かつ即時性の高い価値であるため。

**独立したテスト**: シミュレーターで地震データを流し、WebUIの背景色が変化すること、およびWebUIを開いているブラウザから音声が出力されることを確認する。

**受け入れシナリオ**:

1. **前提**: WebUIが開いている。**操作**: STA/LTAしきい値を超えるデータを入力する。**結果**: 1秒以内にUIがアラート状態（赤点滅等）になり、ブラウザから音が鳴る。
2. **前提**: アラート状態である。**操作**: リセットしきい値を下回る。**結果**: UIが通常状態に戻り、アラートログに記録される。

---

### ユーザーストーリー 2 - イベントスナップショットの自動生成 (優先度: P2)

分析者として、アラートが発生した際の波形の詳細を画像として残したい。後でWebUIの履歴から直接画像を確認し、どのような揺れだったのかを即座に検証できる。

**この優先度の理由**: イベントの記録と事後検証のために重要であるため。

**独立したテスト**: アラートを発生させ、サーバー内の指定ディレクトリにPNG画像が生成され、WebUIからそれが表示できることを確認する。

**受け入れシナリオ**:

1. **前提**: システムが稼働中。**操作**: アラートが発生する。**結果**: 発生から数秒以内に、アラート前後（例: 前30秒、後30秒）の波形プロット画像が保存され、UIの履歴から閲覧可能になる。

---

### ユーザーストーリー 3 - 重層的な電子メール通知 (優先度: P3)

管理者として、外出先でも地震の発生と詳細を漏れなく知りたい。発生時にまず一報を受け取り、終了時に最大震度などの詳細情報を受け取ることで、事態の推移を正確に把握できる。

**この優先度の理由**: 遠隔監視において即時報と詳細報の両立が安心感と正確な判断に繋がるため。

**独立したテスト**: SMTPサーバーを設定し、アラート発生時と終了時のそれぞれでメールが届くことを確認する。

**受け入れシナリオ**:

1. **前提**: 正しいSMTP設定がなされている。**操作**: アラートが発生する。**結果**: 発生直後にチャンネル名と時刻を含む「発生報」メールが送信される。
2. **前提**: アラートが継続中。**操作**: リセットしきい値を下回る。**結果**: 最大STA/LTA比、継続時間、および画像URLを含む「詳細報」メールが送信される。

---

### エッジケース

- **連続したトリガー**: 短時間に連続してアラートが発生した場合、メールの連投を抑制するか？（仮定: 1つのイベントが終了するまでは重複して送信しない）。
- **音声の重複**: 複数のチャンネルで同時にアラートが発生した場合の音声出力。（仮定: ブラウザ側で重複して再生せず、1つの警告音を継続または再開する）。
- **ネットワーク切断**: SMTPサーバーに接続できない場合。（仮定: エラーをログに記録し、リトライは行わない）。

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは、STA/LTAトリガー検知時にWebUIへWebSocketを通じて即座に通知を送信しなければならない。
- **FR-002**: WebUIは、アラート受信時に画面のフラッシング（点滅）および各クライアントブラウザでの音声による通知を行わなければならない。
- **FR-003**: システムは、アラート発生時に該当期間の波形プロット（PNG形式）をサーバーのローカルディレクトリに保存し、WebUIからアクセス可能にしなければならない。
- **FR-004**: システムは、アラートの発生（Trigger）時および終了（Reset）時の両方のタイミングで、設定されたSMTPサーバーを介して通知メールを送信しなければならない。
- **FR-005**: システムは、WebUI上に過去24時間のアラート履歴を表示するリストを提供しなければならない。
- **FR-006**: 警告音の有効/無効、およびメール送信の有効/無効をユーザーが設定（設定ファイルまたはUI）できなければならない。

### 主要なエンティティ

- **AlertNotification**: アラートの状態（開始/終了）、時刻、チャンネル、最大比率、画像パスを含むオブジェクト。
- **SmtpConfig**: ホスト、ポート、ユーザー名、パスワード、送信先アドレス。

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: アラート検知からWebUIの視覚的変化開始までの遅延が 500ms 以内であること。
- **SC-002**: アラート画像（PNG）の生成が、トリガーから 10秒以内（データのバッファリング完了後）に完了すること。
- **SC-003**: 設定されたすべての通知手段（UI, 音, メール2通）が、システム負荷が高い状態でも欠落なく実行されること。
- **SC-004**: WebUIの履歴リストから、生成されたスナップショット画像にアクセス（表示）できること。
