# Tasks: STA/LTA Calculation Logic

**Input**: Design documents from `/specs/003-sta-lta-calc/`
**Prerequisites**: plan.md, spec.md, data-model.md

## Format: `[ID] [P?] [Story] Description`

- **[P]**: Can run in parallel (different files, no dependencies)
- **[Story]**: Which user story this task belongs to (e.g., US1)
- Include exact file paths in descriptions

---

## Phase 1: Setup (Test Infrastructure & Structure)

**Purpose**: Establish the testing verification tool and module structure.

- [X] T001 Create `rsudp-rust/tests/scripts/generate_stalta_reference.py` that uses `obspy` to generate a CSV file with input data and expected STA/LTA ratios.
- [X] T002 Create `rsudp-rust/src/trigger.rs` (empty for now) and expose it via `pub mod trigger;` in `rsudp-rust/src/lib.rs`.

---

## Phase 2: Foundational (Data Model)

**Purpose**: Define the state structure for the algorithm.

- [X] T003 Define the `RecursiveStaLta` struct in `rsudp-rust/src/trigger.rs` with fields `csta`, `clta`, `sta`, `lta` (all `f64`), deriving `Debug` and `Clone`.
- [X] T004 Implement a `new(nsta: usize, nlta: usize)` constructor for `RecursiveStaLta` that calculates coefficients and initializes state to 0.0.

---

## Phase 3: User Story 1 - Calculate STA/LTA (Priority: P1)

**Goal**: Implement the recursive STA/LTA algorithm and verify it matches `obspy`.

**Independent Test**: The Rust implementation processes the synthetic data generated by the Python script and outputs ratios that match within 1e-6 tolerance.

### Tests for User Story 1

- [X] T005 [US1] Create a test module in `rsudp-rust/src/trigger.rs` (or separate test file) that runs the Python script to generate `reference.csv`, reads it, and prepares for comparison. (Note: Requires Python environment).

### Implementation for User Story 1

- [X] T006 [US1] Implement the `process(&mut self, sample: f64) -> f64` method in `RecursiveStaLta` using the recursive formula.
- [X] T007 [US1] Implement the `process_chunk(&mut self, data: &[f64]) -> Vec<f64>` helper method for batch processing.
- [X] T008 [US1] Update the test from T005 to feed the input data from `reference.csv` into `process_chunk` and assert that the output matches the expected ratios from the CSV.

---

## Phase 4: Polish & Cross-Cutting Concerns

**Purpose**: Robustness and documentation.

- [X] T009 Handle `NaN` and `Inf` inputs in `process` (e.g., treat as 0.0 or propagate safely) and add a unit test for this case.
- [X] T010 Add rustdoc comments to `RecursiveStaLta` and its methods explaining the algorithm and parameters.
- [X] T011 Run `cargo clippy` and fix any linting warnings.

---

## Dependencies & Execution Order

- **Phase 1 (Setup)**: Can start immediately.
- **Phase 2 (Foundational)**: Depends on T002.
- **Phase 3 (User Story 1)**: Depends on Phase 2 and T001.
- **Phase 4 (Polish)**: Depends on Phase 3.

### Parallel Opportunities

- T001 (Python script) and T002/T003 (Rust struct) can be done in parallel.

## Implementation Strategy

### MVP Delivery

1.  Create the Python verification script (critical for correctness).
2.  Implement the Rust logic.
3.  Run the comparison test.
4.  Refine for edge cases.
