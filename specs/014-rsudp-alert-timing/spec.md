# Feature Specification: rsudp準拠のアラート投稿タイミング実装 (rsudp-style Alert Post Timing)

**Feature Branch**: `014-rsudp-alert-timing`  
**Created**: 2025-12-21  
**Status**: Draft  
**Input**: User description: "現在、アラートでのplot画像の送信や、震度階級情報のまとめはRESETのタイミングで行っていますが、RESETはアラート検出の処理で使うものなので不適切です。rsudp実装ではアラート発生タイミングがplotに表示している時間のうち60%か70%経過したタイミングで投稿を行います。rsudpの実装を調べていただけますか？"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - rsudp準拠のタイミングでのスナップショット生成 (Priority: P1)

分析者として、地震イベントの主要動だけでなく、その後の経過（コーダ波など）も十分に含んだアラート画像を受け取りたい。現在の `RESET` タイミング（揺れが収まった直後）での生成では、イベント全体を最適なレイアウトで捉えられない場合がある。`rsudp` と同様に、トリガー発生から一定の比率（表示期間の約70%）が経過したタイミングで画像を生成することで、一貫性のある、かつ情報量の多いスナップショットを得ることができる。

**この優先度の理由**: プロジェクトの目標である `rsudp` 互換性を高め、実用的な解析画像を安定して提供するため。

**Independent Test**: シミュレーターでアラートを発生させ、表示期間（例: 90秒）に対して約70%（例: 63秒）経過したタイミングで画像生成とメール送信（Reset報）が行われることを確認する。その際、画像内でトリガー時点が適切な位置（30%または70%）にあることを視覚的に確認する。

**Acceptance Scenarios**:

1. **Given** プロット表示期間が 90秒に設定されている, **When** `EHZ` チャンネルでアラートがトリガーされる, **Then** システムは `RESET` イベントを待たず、トリガーから約 63秒（90秒の70%）後にスナップショットを生成し、メールを送信する。
2. **Given** アラートが継続中である, **When** 画像生成タイマーが満了する, **Then** その時点までの最大震度階級を含む詳細メッセージが生成され、通知される。

---

### User Story 2 - 設定可能な投稿比率 (Priority: P2)

管理者として、イベントのどの部分を重点的に画像に残すかを調整したい。観測環境や目的によって、トリガー前のデータを多く残したい場合や、トリガー後の経過を長く見たい場合がある。

**この優先度の理由**: システムの柔軟性を高め、ユーザーの好みに合わせるため。

**Independent Test**: 設定ファイルで `save_pct` を変更し、画像生成までの待ち時間が動的に変化することを確認する。

---

### Edge Cases

- **短時間に連続するアラート**: 最初の画像生成待ちの間に次のアラートが発生した場合。（対応: `rsudp` のように、既存の保存予約を優先し、過度な連投を抑制する。または各イベントに対して独立したタイマーを持つ）。
- **表示期間の変更**: 実行中に `duration` 設定が変更された場合。（対応: 予約済みのタイマーには影響させない、または最新の設定値で再計算する）。
- **RESETが先に来る場合**: 非常に短い揺れで、70%経過前に `RESET` した場合。（対応: 指定された比率まで待ち続けてから生成する。これにより背景ノイズの状態も確認できる）。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、アラートの `Trigger` 発生時に、スナップショット生成と詳細通知（サマリ報）の送信をスケジュールしなければならない。
- **FR-002**: スケジュールされる遅延時間は、`プロット表示期間 (duration) × 保存比率 (save_pct)` で計算されなければならない。
- **FR-003**: デフォルトの `save_pct` は 0.7 (70%) とし、設定ファイルまたは起動引数で変更可能にしなければならない。
- **FR-004**: スナップショットの生成と通知の実行は、`RESET` イベントの発生有無にかかわらず、スケジュールされた時刻に行われなければならない。
- **FR-005**: 生成されるメッセージ（震度階級等）は、スケジュールされた時点での「スナップショット表示範囲内」の最大値に基づかなければならない。
- **FR-006**: アラートの `RESET` 処理は、純粋に検知ロジック（STA/LTA状態の遷移）のみを担当し、画像の生成やサマリ送信のトリガーとしては使用しないようにリファクタリングしなければならない。

### Key Entities

- **AlertTask**: スケジュールされた画像生成タスク。実行予定時刻、トリガー時刻、チャンネル情報、現在の最大震度などを保持する。
- **PlotConfig (Updated)**: `save_pct` パラメータを追加。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 画像生成の実行時刻が、`トリガー時刻 + (duration * save_pct)` に対して誤差 1秒以内に収まっていること。
- **SC-002**: 生成された画像において、トリガーポイントが指定された比率の位置（30%または70%）に安定して配置されていること。
- **SC-003**: 複数のチャンネルでアラートが発生した場合でも、それぞれのスケジュールが適切に管理（または統合）されること。

## Assumptions

- `rsudp` の実装（`self.save_pct = 0.7` かつ `time.time() + int(save_pct * seconds)`）に基づき、トリガーから一定時間「待ってから」撮る方式を採用する。
- これにより、スライディングウィンドウ方式のプロットにおいて、イベントが左側に流れていく過程で最適な位置に来た瞬間をキャプチャする。