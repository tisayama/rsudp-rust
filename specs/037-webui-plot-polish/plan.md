# Implementation Plan: WebUI Plot Polish

**Branch**: `037-webui-plot-polish` | **Date**: 2025-02-10 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/037-webui-plot-polish/spec.md`

## Summary

Improve WebUI waveform and spectrogram display to match rsudp desktop application visuals. This involves four changes, all frontend-only:
1. Replace relative X-axis time labels with absolute HH:MM:SS (UTC) timestamps at 10-second intervals
2. Add white/light border frames around waveform and spectrogram plot areas
3. Implement 1-2-5 series Y-axis tick algorithm for round-number evenly-spaced ticks
4. Remove the Alert History page and related navigation

## Technical Context

**Language/Version**: TypeScript (Next.js 14+) for frontend; Rust backend unchanged
**Primary Dependencies**: Next.js, React, Tailwind CSS (all existing)
**Storage**: N/A (UI-only changes)
**Testing**: Visual inspection + `cargo test` for Rust (unchanged), jest for frontend unit tests
**Target Platform**: Web browser (Chrome, Firefox, Safari)
**Project Type**: Web application (frontend-only changes)
**Performance Goals**: Maintain 30 FPS canvas rendering without degradation
**Constraints**: Canvas-based rendering, existing RingBuffer architecture
**Scale/Scope**: 3 files modified, 2 files deleted, 1 new utility file

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. 安定性と信頼性 | PASS | Visual-only changes, no core logic modification |
| II. 厳密なテスト | PASS | Visual testing against reference screenshot; niceNumber utility can be unit tested |
| III. 高いパフォーマンス | PASS | Minimal computation added (time formatting, tick calculation); 30 FPS target maintained |
| IV. コードの明瞭性と保守性 | PASS | Clean separation of niceNumber utility; removal of dead code improves maintainability |
| V. 日本語による仕様策定 | PASS | Spec written; constitution allows English for implementation artifacts |
| VI. 標準技術スタック | PASS | Using existing Next.js + Tailwind CSS stack |
| VII. 自己検証の義務 | PASS | Visual verification against reference screenshot before merge |
| VIII. ブランチ運用 | PASS | Working on feature branch `037-webui-plot-polish` |

No gate violations. Proceeding to Phase 0.

## Project Structure

### Documentation (this feature)

```text
specs/037-webui-plot-polish/
├── plan.md              # This file
├── spec.md              # Feature specification
├── research.md          # Phase 0 research output
├── quickstart.md        # Phase 1 verification scenarios
├── references/
│   └── R6E01-2025-11-25-090123.png  # rsudp desktop reference screenshot
├── checklists/
│   └── requirements.md  # Quality checklist
└── tasks.md             # Task list (generated by /speckit.tasks)
```

### Source Code (files to modify)

```text
webui/
├── components/
│   └── ChannelPairCanvas.tsx     # PRIMARY: Y-axis ticks, borders, time axis
├── hooks/
│   └── useAlerts.ts              # KEEP: Audio playback (not history-related)
├── lib/
│   ├── nice-number.ts            # NEW: 1-2-5 series tick calculation utility
│   ├── types.ts                  # MODIFY: Remove AlertEvent type
│   └── engineering-format.ts     # UNCHANGED: Still used for Y-axis formatting
├── src/app/
│   ├── page.tsx                  # MODIFY: Remove Alert History link, pass timestamps
│   └── history/
│       └── page.tsx              # DELETE: Alert History page
```

**Structure Decision**: Existing web application structure. All changes are in the `webui/` frontend directory. No backend changes needed. One new utility file (`nice-number.ts`) for the 1-2-5 tick algorithm, keeping it separate for testability.

## Key Design Decisions

### 1. Absolute Time Axis - Timestamp Propagation

**Problem**: The RingBuffer stores only sample values (Float32Array), no timestamps. ChannelPairCanvas currently draws relative seconds (0, 10, 20...) and has no knowledge of absolute time.

**Solution**: Track the latest waveform timestamp per channel in `page.tsx` and pass it as a new prop `latestTimestamp: Date | null` to ChannelPairCanvas. The canvas component then:
- Right edge = latestTimestamp (or `new Date()` if null)
- Left edge = right edge - windowSeconds
- Draw labels at 10-second-aligned boundaries within the visible range
- Format as HH:MM:SS using UTC

**Time label placement** (from reference screenshot analysis):
- Time labels (HH:MM:SS) are drawn **between** the waveform and spectrogram plots, in a gap area
- "Time (UTC)" axis title is drawn **below** the spectrogram
- When spectrogram is not shown, time labels appear below the waveform

**Rationale**: Minimal changes to existing architecture. No RingBuffer modification needed. The timestamp already arrives with each waveform packet.

### 2. Y-Axis Ticks - 1-2-5 Series Algorithm

**Problem**: Current code divides the Y range into 5 equal parts, producing non-round tick values (e.g., -1100, -550, 0, 550, 1100).

**Solution**: Implement a `niceNumber(range, targetTicks)` utility that:
1. Computes the rough step = range / targetTicks
2. Finds the order of magnitude: `10^floor(log10(roughStep))`
3. Normalizes: `fraction = roughStep / magnitude`
4. Snaps to 1-2-5 series: if fraction <= 1.5 → 1, <= 3.5 → 2, <= 7.5 → 5, else → 10
5. Returns `niceStep = snappedFraction * magnitude`

Then draw ticks at every multiple of niceStep within [yMin, yMax], targeting 3-7 ticks.

**Additional details from reference screenshot**:
- Y-axis is NOT forced symmetric around zero — uses actual data range (e.g., -2 to +3 mm/s)
- Faint grey horizontal grid lines are drawn at each Y-axis tick position inside the plot area
- Y-axis tick labels include the unit inline (e.g., "-2 mm/s", "0 mm/s", "1 mm/s")

### 3. White Border Frames

**Problem**: No visual border around the plot data area.

**Solution**: Draw `strokeRect` on the canvas context after all other rendering:
- Waveform: rect from (LEFT_MARGIN, 0) to (plotWidth, waveformHeight)
- Spectrogram: rect from (LEFT_MARGIN, 0) to (plotWidth, spectrogramHeight)
- Stroke color: thin white/light-grey line (matches rsudp desktop appearance)
- Line width: 1px

### 4. Horizontal Grid Lines

**Problem**: No grid lines inside the waveform area, making it harder to read amplitude values.

**Solution**: Draw faint horizontal lines at each Y-axis tick position:
- Color: `rgba(255, 255, 255, 0.15)` (very faint, not distracting)
- Line width: 1px
- Drawn across the full plot width (LEFT_MARGIN to LEFT_MARGIN + plotWidth)

### 5. Frequency Axis Label Update

**Problem**: Current code shows only "Hz" as the rotated frequency axis label. Reference shows "Frequency (Hz)".

**Solution**: Change the rotated label text from `'Hz'` to `'Frequency (Hz)'`.

### 6. Alert History Removal

**Files to delete**: `webui/src/app/history/page.tsx`
**Files to modify**:
- `webui/src/app/page.tsx` — Remove `<Link href="/history">` button and `import Link`
- `webui/lib/types.ts` — Remove `AlertEvent` interface (only used by history page)

**Files to keep**:
- `useAlerts.ts` — Audio playback for active alerts (not related to history page)
- `VisualAlertMarker` type — Used by ChannelPairCanvas for alert markers on waveform

## Complexity Tracking

No constitution violations to justify. All changes are minimal and follow existing patterns.
