# Specification: Philips Hue V2 Integration

**Feature**: Philips Hue V2 Integration
**Status**: DRAFT
**Feature Branch**: `031-hue-v2-integration`

## 1. Executive Summary



This feature integrates Philips Hue smart lighting into the existing alert system using the Hue API v2. It provides a two-stage visual notification system: an immediate "warning" pulse upon initial trigger, and a "report" pulse upon reset indicating the finalized seismic intensity using JMA standard colors. A dedicated CLI tool assists with setup (discovery, pairing, ID listing), while the main application handles real-time alerting and robust bridge connectivity tracking.



## 2. Clarifications



*   **Alert Signal (Trigger)**: Yellow Pulse (Breathe effect). Triggered immediately upon STA/LTA detection.

*   **Alert Signal (Reset)**: Pulse (Breathe effect) for **20 seconds**. The color is determined by the finalized JMA Seismic Intensity of the event, following JMA standard color codes.

*   **Setup Workflow**: A separate CLI command handles discovery and pairing (generating the app key). The user manually adds this key and target Light/Room/Zone IDs to the configuration file.

*   **Connectivity**: The system periodically re-scans or verifies the Bridge via mDNS/ID to handle IP address changes (DHCP).

*   **Alert Concurrency**: **Immediate Preemption**. If a new alert triggers while a previous event's "Reset" pulse is running, the system MUST immediately stop the Reset pulse and start the new Trigger (Yellow) pulse.



## 3. User Scenarios



### 3.1. Setup & Configuration (CLI)

**Actor**: User

**Scenario**: Initial setup of Hue integration

**Flow**:

1. User runs the setup command (e.g., `rsudp-hue setup`).

2. Tool discovers local Hue Bridges via mDNS.

3. User presses the Link Button on the bridge.

4. Tool exchanges keys and outputs the `app_key`.

5. User runs `rsudp-hue list` to see available Lights, Rooms, and Zones with their IDs.

6. User edits `rsudp.toml` to add the `app_key` and a list of target IDs (Lights, Rooms, Zones).



### 3.2. Alert Visual Signaling

**Actor**: System (Alert Manager)

**Scenario**: A seismic event occurs

**Flow**:

1. **Trigger**: STA/LTA triggers an alert.

2. System immediately sends a **Yellow Pulse** command to configured lights.

3. **Event**: The shaking continues; the system calculates max intensity.

4. **Reset**: The alert condition ends (Reset).

5. System calculates the final JMA Seismic Intensity (e.g., Intensity 4).

6. System sends a **Pulse command (20 seconds)** with the JMA-defined color (e.g., RGB 250,230,150 for Intensity 4).

7. After 20 seconds, lights revert to their previous state.



## 4. Functional Requirements



### 4.1. Service Discovery & Connectivity

1. **Persistent Discovery**: The system MUST periodically verify the Hue Bridge's IP address using mDNS or Bridge ID, ensuring connectivity even if the local IP changes (DHCP).

2. **Initial Discovery (CLI)**: A helper command MUST be provided to discover bridges and perform the initial Link Button handshake to generate an `app_key`.



### 4.2. Configuration

1. The integration MUST be configured via the main configuration file (`rsudp.toml`).

2. Required settings:

    *   `app_key`: The pairing key generated by the CLI tool.

    *   `target_ids`: A list of IDs (Light, Room, or Zone) to control.

    *   `bridge_id`: (Optional/Recommended) To uniquely identify the bridge for IP tracking.



### 4.3. Device Control & Alert Logic

1. **Trigger (Warning)**: Upon STA/LTA trigger, send a **Yellow** (approx. 255, 255, 0) Pulse effect to all target IDs.

2. **Reset (Report)**: Upon alert reset, determine the JMA Intensity Class based on the event's max intensity.

3. **JMA Color Mapping**: Apply the following colors for the Reset pulse:

    *   **Int 7**: RGB(180, 0, 104)

    *   **Int 6+**: RGB(165, 0, 33)

    *   **Int 6-**: RGB(255, 40, 0)

    *   **Int 5+**: RGB(255, 153, 0)

    *   **Int 5-**: RGB(255, 230, 0)

    *   **Int 4**: RGB(250, 230, 150)

    *   **Int 3**: RGB(0, 65, 255)

    *   **Int 2**: RGB(0, 170, 255)

    *   **Int 1**: RGB(242, 242, 255) (or White/Blue-White)

4. **Duration**: The Reset pulse MUST last for **20 seconds**.

5. **State Restoration**: After the 20-second report pulse, lights MUST revert to their pre-alert state (On/Off, Color, Brightness). *Note: If lights were OFF, they should return to OFF.*

6. **Preemption**: If a new Trigger event occurs during an active Reset pulse, the Reset pulse MUST be terminated immediately, and the new Trigger (Yellow) pulse MUST begin.



### 4.4. CLI Tools

1. **Setup**: `setup` subcommand to discover bridge, prompt for link button press, and output `app_key`.

2. **List**: `list` subcommand to query the bridge using a provided `app_key` and display a table of Lights, Rooms, and Zones with their API IDs.



## 5. Success Criteria



1. **IP Tracking**: System automatically reconnects to the Bridge within 60 seconds if its local IP address changes.

2. **Color Accuracy**: The displayed colors visually match the JMA standard (within hardware limitations of Hue bulbs).

3. **Response Time**: Trigger (Yellow) pulse initiates within 2 seconds of STA/LTA detection.

4. **Recovery**: Lights correctly restore their original state after the 20-second post-event pulse.



## 6. Assumptions & Constraints



*   **Config**: Users are responsible for correctly copying keys and IDs into the config file.

*   **Hardware limits**: Pulse effects rely on the Bridge's capability; network congestion may affect synchronization of multiple lights.

*   **Color Space**: RGB values will be converted to XY or CIE color space as required by Hue API v2.



## 7. Security Considerations



*   **Credentials**: The `app_key` is stored in plaintext in the config file (acceptable per requirements).

*   **Local Access**: Discovery and control are strictly local network operations.
