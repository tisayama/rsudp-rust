# 機能仕様書: rsudp互換プロット生成 (rsudp Plot Compatibility)

**機能ブランチ**: `011-rsudp-plot-compatibility`  
**作成日**: 2025-12-19  
**ステータス**: 計画準備完了  
**インプット**: ユーザー説明: "アラートで出力する画像をrsudpのplotシステムと同じようにしたいです。waveformとspectrogramの仕様、実装、見栄えを可能な限り調べて模倣してほしいです。"

## Clarifications

### Session 2025-12-19
- Q: スペクトログラムの計算パラメータ（ウィンドウサイズ、オーバーラップ率など）は？ → A: rsudpの正確な模倣。rsudpのソースコード（matplotlib実装）を調査し、FFTサイズ、オーバーラップ率、およびカラーマップの設定を完全に一致させます。
- Q: 複数チャンネルのレイアウト → A: 1枚の画像に統合 (Vertical Stack)。ステーション内の全チャンネル（例: 3成分）の波形とスペクトログラムを縦に積み重ねて1枚の画像として生成します。

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - rsudpスタイルの波形プロット (Priority: P1)

分析者として、アラート発生時に生成される波形画像（Waveform Plot）が、オリジナルの `rsudp` と同じスタイル（色、グリッド、レイアウト）であることを望む。これにより、既存の `rsudp` ユーザーが違和感なくデータを解釈でき、視覚的な一貫性が保たれる。

**この優先度の理由**: プロジェクトの主要な目標の一つが `rsudp` の完全な代替（リライト）であるため、出力物の互換性は重要。

**独立したテスト**: シミュレーターでアラートを発生させ、生成されたPNG画像をオリジナルの `rsudp` が生成する画像と比較し、レイアウト、配色、ラベル配置が酷似していることを確認する。

**受け入れシナリオ**:

1. **前提**: アラートが発生する。**操作**: システムが波形画像を生成する。**結果**: 背景色が白、グリッドが薄いグレー、波形が青色で、上部にステーション情報、下部に時刻ラベルが表示された画像が出力される。

---

### ユーザーストーリー 2 - スペクトログラムの生成と表示 (Priority: P2)

分析者として、波形だけでなく周波数成分の変化（スペクトログラム）も確認したい。これにより、ノイズと実際の地震波を視覚的に区別しやすくなる。`rsudp` と同様に、波形の下にスペクトログラムを並べて表示してほしい。

**この優先度の理由**: 地震解析において周波数情報は不可欠であり、`rsudp` の主要機能の一つであるため。

**独立したテスト**: アラートを発生させ、生成された画像にスペクトログラムが含まれていることを確認する。また、周波数軸（Y軸）と時間軸（X軸）が波形と同期していることを確認する。

**受け入れシナリオ**:

1. **前提**: アラートが発生する。**操作**: システムが画像を生成する。**結果**: 画像の下半分にスペクトログラムが表示され、強い信号部分が暖色系（赤・黄）で表示される。

---

### ユーザーストーリー 3 - マルチチャンネル対応プロット (Priority: P3)

管理者として、複数のチャンネル（例: EHZ, EHE, EHN）のデータを一つの画像で確認したい。`rsudp` のように全チャンネルを縦に並べて表示することで、各成分の揺れ方や位相差を一目で把握できる。

**この優先度の理由**: 3成分（上下、東西、南北）を総合的に判断するために必要。

**独立したテスト**: 複数チャンネルを含むデータを流し、全チャンネル分のプロットが1枚の画像に統合されて生成されることを確認する。

**受け入れシナリオ**:

1. **前提**: 3チャンネルのデータを受信中。**操作**: アラートが発生する。**結果**: 3チャンネル分の波形とスペクトログラムが縦にスタックされた1枚の画像が生成される。

---

### エッジケース

- **データ不足**: アラート発生直後で十分なデータ（スペクトログラム計算用の履歴）がない場合。（仮定: 可能な範囲で描画するか、パディングする）。
- **高負荷**: スペクトログラム計算（FFT）は負荷が高いため、画像生成がアラート通知を遅延させないか。（仮定: 非同期で処理し、通知自体は即座に行う）。

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは、`rsudp` の `matplotlib` スタイル（配色、フォントサイズ、グリッド線）を模倣した波形プロットを生成しなければならない。
- **FR-002**: システムは、波形データからスペクトログラムを計算し、波形プロットと時間軸を合わせて描画しなければならない。計算パラメータ（NFFT等）およびカラーマップは `rsudp` の実装を模倣する。
- **FR-003**: 生成される画像は、ステーション名、チャンネル名、開始時刻、最大加速度（PGA）などのメタデータをタイトルまたは注釈として含んでいなければならない。
- **FR-004**: 画像生成処理は、アラート検知のリアルタイム性を損なわないよう、非同期（バックグラウンド）で実行されなければならない。
- **FR-005**: 生成された画像は、WebUIのアラート履歴から閲覧可能でなければならない（既存機能との統合）。
- **FR-006**: 複数チャンネルが同時にトリガーされた場合、それらを1枚の画像に縦に並べて（スタックして）プロットしなければならない。

### 主要なエンティティ

- **PlotConfig**: プロットの色、サイズ、スペクトログラムの設定（FFTサイズ等）を保持する設定体。
- **Spectrogram**: FFT計算結果を保持する中間データ構造。

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: 生成された画像が、オリジナルの `rsudp` の出力と比較して、ユーザーが見分けがつかないレベル（レイアウト、配色）であること。
- **SC-002**: スペクトログラム生成を含む画像作成処理が、3秒以内（Raspberry Pi 4相当のスペックを想定）に完了すること。
- **SC-003**: スペクトログラムの周波数分布が、既知のテスト信号（例: 10Hzのサイン波）に対して正しく表示されること。