# Feature Specification: アラート画像への震度階級表示 (Intensity Display on Alert Plots)

**Feature Branch**: `012-intensity-on-plot`  
**Created**: 2025-12-21  
**Status**: 計画準備完了  
**Input**: User description: "Alertが発生して画像を作成するときに、画像に写っている時間内で最高の震度階級を画像の中に大きめの文字で出力するようにしてください。もし日本語のフォントが必要な際はNoto Sans Japaneseを使ってください。また、震度階級の表示部分では、画像は白抜きで背景色は震度の大きさごとの色分けでお願いします。"

## Clarifications

### Session 2025-12-21
- Q: 震度階級ボックスの具体的な配置場所 → A: 右上 (Top-Right)。タイトル行の右端、あるいは最初の波形プロットの右上エリアに配置し、他の情報との干渉を最小限に抑えつつ視認性を確保します。
- Q: 日本語フォント（Noto Sans Japanese）の調達方法 → A: バイナリに内蔵 (Embedded)。実行環境のポータビリティを確保するため、フォントファイルをバイナリに含めてコンパイルします。
- Q: 震度階級ごとの配色基準 → A: 気象庁 (JMA) 公式配色。震度3は黄色、4はオレンジ、5弱は赤など、国内で一般的に普及している配色基準を採用し、直感的な把握を可能にします。
- Q: 震度表示のテキスト内容 → A: 「震度 X」形式。例として「震度 3」や「震度 5弱」のように、「震度」という言葉と階級を組み合わせて表示し、最も分かりやすく誤解のない表記にします。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 視認性の高い震度表示 (Priority: P1)

分析者として、生成されたアラート画像を一目見ただけで、その震災イベントの最大規模（震度階級）を把握したい。画像の隅に大きく色付けされた震度アイコンが表示されることで、数値データを読み解く前に直感的な判断が可能になる。

**この優先度の理由**: アラート画像の主目的は状況の即時把握であり、震度階級はその最も重要な指標であるため。

**Independent Test**: シミュレーターで震度3相当のデータを流し、生成された画像に「震度 3」と大きく書かれた黄色いボックス（白抜き文字）が表示されていることを視覚的に確認する。

**Acceptance Scenarios**:

1. **Given** 震度2.8（震度3）の地震イベントを含む90秒のデータがある, **When** アラート画像が生成される, **Then** 画像内に「震度 3」という大きな白抜き文字と、気象庁基準の震度3に対応する背景色（黄色）の矩形が表示される。
2. **Given** 複数のチャンネル（ENE, ENN, ENZ）がプロットされている, **When** 最大震度を計算する, **Then** その時間枠内かつ全チャンネルを考慮した「最大」の震度階級が採用される。

---

### User Story 2 - 日本語フォントによる正確な表記 (Priority: P2)

国内のユーザーとして、「震度」という漢字を含めた正しい日本語表記で情報を確認したい。システムに Noto Sans Japanese を組み込むことで、文字化けや不自然なフォントを避け、公的な観測情報に近い外観を実現する。

**この優先度の理由**: 日本の地震情報を扱うシステムとして、日本語表記の正確さと美しさは信頼性に直結するため。

**Independent Test**: 画像を生成し、「震度」という漢字が Noto Sans Japanese フォントで鮮明に描画されていることを確認する。

---

### Edge Cases

- **震度0またはマイナス**: 計測震度が極めて低い場合。（対応: 「震度 0」として表示するか、表示を抑制するか検討。デフォルトは「震度 0」表示）。
- **フォントの欠落**: バイナリ内蔵により発生しない想定だが、描画エラー時は標準フォントにフォールバックする。
- **非常に短いアラート**: データが数秒しかない場合。（対応: 存在するデータ範囲で最大値を計算する）。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、アラート画像（スナップショット）の対象時間枠内における最大計測震度を算出し、対応する「震度階級」を決定しなければならない。
- **FR-002**: システムは、決定された震度階級を画像内の右上 (Top-Right) に大きく描画しなければならない。
- **FR-003**: 震度表示は、「震度 3」や「震度 5弱」のように「震度」＋「階級」の形式とし、白抜きのテキストと、震度階級に応じた背景色の矩形で構成されなければならない。
- **FR-004**: 震度の背景色は、気象庁 (JMA) の公式基準に準じた配色を採用しなければならない。
- **FR-005**: 日本語描画には、バイナリに内蔵した `Noto Sans Japanese` フォントを使用しなければならない。
- **FR-006**: 複数チャンネルが表示されている場合、その全チャンネルの合成ベクトルまたは個別の最大値から、画像全体の最大震度を特定しなければならない。

### Key Entities

- **IntensityClass**: 0, 1, 2, 3, 4, 5弱, 5強, 6弱, 6強, 7 の各階級定義。
- **IntensityTheme**: 各階級に対応する JMA 準拠の RGB 色コード定義。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 生成された画像内の震度表示が、全体の面積の少なくとも 5% 以上を占める大きさで描画され、一目で視認できること。
- **SC-002**: 算出された震度階級が、既存の計測震度計算ロジック（Feature 008）の結果と完全に一致すること。
- **SC-003**: 日本語フォントがアンチエイリアスを伴って滑らかに描画されていること。
- **SC-004**: 画像生成の追加処理（震度計算と描画）による遅延が 500ms 以下であること。

## Assumptions

- 震度階級の色分けは、気象庁公式配色（JMA Color Palette）に従うものとする。
- 表示位置は、波形やスペクトログラムと重なりにくい右上 (Top-Right) をデフォルトとする。