# Feature Specification: アラートメッセージへの震度階級追加 (Intensity Inclusion in Alert Messages)

**Feature Branch**: `013-alert-message-intensity`  
**Created**: 2025-12-21  
**Status**: Draft  
**Input**: User description: "アラートシステムはSTA/LTAの検知で発動しますが、plotの投稿タイミング(60−70％)で震度階級をアラートメッセージに含めるようにしてください。もし震度階級0だったら揺れを検出できませんでしたと出力してください。震度階級1以上なら、例えば震度6弱相当の揺れを検出しましたと出力してください"

## Clarifications

### Session 2025-12-21
- Q: 震度階級を含めたメッセージをどのタイミングの通知（Trigger/Reset）に反映すべきか？ → A: Reset（終了）時の通知のみ。主要動が通過して最大震度が確定し、画像（plot）が生成・投稿される終了タイミングの通知に詳細メッセージを含めます。発生報は現状通り速報として扱います。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - テキストによる震度情報の即時把握 (Priority: P1)

通知を受け取ったユーザーとして、画像を開く前に地震の規模（震度階級）をテキストで知りたい。メールの件名や本文、あるいはWebUIのアラートログに「震度3相当の揺れを検出しました」と具体的に記載されることで、状況判断を迅速に行えるようになる。

**この優先度の理由**: 画像の読み込みが遅い環境や、視覚的に確認する余裕がない場合でも、テキストによる情報は極めて高い価値があるため。

**Independent Test**: シミュレーターで震度2相当の地震を発生させ、送信されるメール（Reset報）またはWebUIのログに「震度2相当の揺れを検出しました」という文言が含まれていることを確認する。

**Acceptance Scenarios**:

1. **Given** 計測震度 1.8（震度2）のイベントが終了した, **When** アラートの集計メッセージ（Reset報）が生成される, **Then** メッセージ内に「震度2相当の揺れを検出しました」というテキストが含まれる。
2. **Given** STA/LTAがトリガーされたが、主要動が含まれず計測震度が 0.4（震度0）だった, **When** アラートの集計メッセージが生成される, **Then** メッセージ内に「揺れを検出できませんでした」というテキストが含まれる。

---

### User Story 2 - ウェブ管理画面での詳細表示 (Priority: P2)

WebUIで過去の履歴を閲覧しているユーザーとして、各イベントの概要を一覧で把握したい。各アラート項目に震度階級に基づいた説明文が表示されることで、どのイベントが重要だったかを一目で判別できる。

**この優先度の理由**: 多数のアラートの中から重要な地震イベントを見つけ出す際の視認性を向上させるため。

**Independent Test**: WebUIの `/history` pageを開き、各アラートカードに「震度X相当の揺れを検出しました」というステータスメッセージが表示されていることを確認する。

---

### Edge Cases

- **階級の強弱**: 「震度5弱」「震度6強」などの表記も正しく反映されるか。（対応: 既存の `get_shindo_class` ロジックと連携し、適切な文字列を生成する）。
- **感度未設定**: StationXMLから感度が得られなかった場合。（対応: デフォルト感度で計算し、その結果に基づいたメッセージを表示する。正確性に欠ける旨の注釈は不要だが、内部で一貫性を保つ）。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、アラート期間（TriggerからResetまで）の最大計測震度に基づいて、日本語の状況説明メッセージを生成しなければならない。
- **FR-002**: 最大震度階級が 0 の場合、メッセージは「揺れを検出できませんでした」としなければならない。
- **FR-003**: 最大震度階級が 1 以上の場合、メッセージは「震度 {階級} 相当の揺れを検出しました」としなければならない（例: 「震度 6弱相当の揺れを検出しました」）。
- **FR-004**: 生成されたメッセージは、アラート終了時に送信される電子メール（Reset報/Summary報）の本文に含まれなければならない。
- **FR-005**: 生成されたメッセージは、WebUI のアラート履歴 API および画面上の表示に反映されなければならない。
- **FR-006**: メッセージの生成タイミングは、スナップショット画像の生成（プロット投稿タイミング）と同期しなければならない。

### Key Entities

- **AlertMessage**: 震度階級に基づいて動的に組み立てられる文字列。
- **WebAlertEvent**: 既存のエンティティに `message` フィールドを正式に追加（または活用）する。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: アラート終了からメッセージ付き通知（メール/UI更新）の送信開始までの遅延が 1秒以内であること。
- **SC-002**: 算出される震度階級およびその表記（弱/強）が、画像内のバッジ表示と 100% 一致すること。
- **SC-003**: 日本語の全角文字（「震度」「相当」など）が、メールクライアントやWebUIで文字化けなく表示されること。

## Assumptions

- 「plotの投稿タイミング」とは、現在のシステムの `Reset` (アラート終了) 時のイベントサマリ送信タイミングを指すものとする。
- 震度計算は Feature 012 で実装された、 snapshot ウィンドウ内の最大値を利用する。
